{% extends "base.html" %}

{% block title %}Dashboard - AMA MESSAGE{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>
            Dashboard
        </h1>
    </div>
</div>

<!-- Estatísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="mb-0" id="total-sms">{{ total_sms or 0 }}</h4>
                        <p class="mb-0">Total de SMS</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-envelope fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="mb-0" id="sms-sent">-</h4>
                        <p class="mb-0">SMS Enviados</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-paper-plane fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="mb-0" id="sms-received">-</h4>
                        <p class="mb-0">SMS Recebidos</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-inbox fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="mb-0" id="queue-pending">{{ total_queue or 0 }}</h4>
                        <p class="mb-0">Na Fila</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Ações Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#sendSmsModal">
                            <i class="fas fa-paper-plane me-2"></i>
                            Enviar SMS
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#bulkSmsModal">
                            <i class="fas fa-users me-2"></i>
                            SMS em Massa
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="/admin/commands" class="btn btn-info w-100">
                            <i class="fas fa-robot me-2"></i>
                            Gerenciar Comandos
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <a href="/modem/ussd" class="btn btn-warning w-100">
                            <i class="fas fa-phone-square-alt me-2"></i>
                            Códigos USSD
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="/modem" class="btn btn-secondary w-100">
                            <i class="fas fa-mobile-alt me-2"></i>
                            Status do Modem
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="/docs" class="btn btn-outline-primary w-100">
                            <i class="fas fa-book me-2"></i>
                            Documentação API
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status do Sistema -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-heartbeat me-2"></i>
                    Status do Sistema
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-success me-2">ONLINE</span>
                    <span>Sistema de SMS</span>
                </div>
                <div class="d-flex align-items-center mb-2" id="twilio-status">
                    <span class="badge bg-warning me-2">VERIFICANDO</span>
                    <span>Provedor SMS (Twilio)</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">ONLINE</span>
                    <span>Base de Dados</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Comandos Ativos
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>{{ total_commands or 0 }}</strong> comandos configurados
                </p>
                <div id="active-commands">
                    <div class="text-muted">Carregando comandos...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modais -->
<!-- Modal Enviar SMS -->
<div class="modal fade" id="sendSmsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar SMS
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sendSmsForm">
                    <div class="mb-3">
                        <label for="phone_to" class="form-label">Número de Telefone</label>
                        <input type="text" class="form-control" id="phone_to" placeholder="+5511999999999" required>
                        <div class="form-text">Use o formato internacional (+55 para Brasil)</div>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Mensagem</label>
                        <textarea class="form-control" id="message" rows="3" placeholder="Digite sua mensagem..." required></textarea>
                        <div class="form-text">
                            <span id="char-count">0</span>/160 caracteres
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendSMS()">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal SMS em Massa -->
<div class="modal fade" id="bulkSmsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>
                    Enviar SMS em Massa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkSmsForm">
                    <div class="mb-3">
                        <label for="phones" class="form-label">Números de Telefone</label>
                        <textarea class="form-control" id="phones" rows="5" placeholder="Um número por linha:&#10;+5511999999999&#10;+5511888888888&#10;+5511777777777" required></textarea>
                        <div class="form-text">Digite um número por linha no formato internacional</div>
                    </div>
                    <div class="mb-3">
                        <label for="bulk_message" class="form-label">Mensagem</label>
                        <textarea class="form-control" id="bulk_message" rows="3" placeholder="Digite sua mensagem..." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="priority" class="form-label">Prioridade</label>
                            <select class="form-select" id="priority">
                                <option value="0">Normal</option>
                                <option value="1">Alta</option>
                                <option value="2">Urgente</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="scheduled_for" class="form-label">Agendar para</label>
                            <input type="datetime-local" class="form-control" id="scheduled_for">
                            <div class="form-text">Deixe em branco para enviar agora</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="sendBulkSMS()">
                    <i class="fas fa-users me-2"></i>
                    Adicionar à Fila
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Carregar estatísticas
function loadStats() {
    fetch('/api/sms/stats')
        .then(response => response.json())
        .then(data => {
            // Atualizar total de SMS (enviados + recebidos)
            const totalSms = data.total_sms_sent + data.total_sms_received;
            document.getElementById('total-sms').textContent = totalSms;
            
            // Atualizar stats individuais
            document.getElementById('sms-sent').textContent = data.total_sms_sent;
            document.getElementById('sms-received').textContent = data.total_sms_received;
            
            // Atualizar fila se necessário
            const queueElement = document.getElementById('queue-pending');
            if (queueElement) {
                queueElement.textContent = data.total_sms_pending;
            }
        })
        .catch(console.error);
}

// Carregar comandos ativos
function loadActiveCommands() {
    fetch('/admin/api/commands')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('active-commands');
            if (data.length === 0) {
                container.innerHTML = '<div class="text-muted">Nenhum comando configurado</div>';
                return;
            }
            
            const activeCommands = data.filter(cmd => cmd.is_active);
            if (activeCommands.length === 0) {
                container.innerHTML = '<div class="text-muted">Nenhum comando ativo</div>';
                return;
            }
            
            container.innerHTML = activeCommands.map(cmd => 
                `<span class="badge bg-primary me-1 mb-1">${cmd.keyword}</span>`
            ).join('');
        })
        .catch(console.error);
}

// Contador de caracteres
document.getElementById('message').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('char-count').textContent = count;
    
    if (count > 160) {
        document.getElementById('char-count').className = 'text-danger fw-bold';
    } else {
        document.getElementById('char-count').className = '';
    }
});

// Enviar SMS individual
function sendSMS() {
    const phone = document.getElementById('phone_to').value.trim();
    const message = document.getElementById('message').value.trim();
    
    if (!phone || !message) {
        alert('Por favor, preencha todos os campos.');
        return;
    }
    
    fetch('/api/sms/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            phone_to: phone,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            alert('SMS enviado com sucesso!');
            document.getElementById('sendSmsForm').reset();
            document.getElementById('char-count').textContent = '0';
            bootstrap.Modal.getInstance(document.getElementById('sendSmsModal')).hide();
            loadStats(); // Recarregar estatísticas
        } else {
            alert('Erro ao enviar SMS: ' + (data.detail || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao enviar SMS');
    });
}

// Enviar SMS em massa
function sendBulkSMS() {
    const phonesText = document.getElementById('phones').value.trim();
    const message = document.getElementById('bulk_message').value.trim();
    const priority = parseInt(document.getElementById('priority').value);
    const scheduledFor = document.getElementById('scheduled_for').value;
    
    if (!phonesText || !message) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    const phones = phonesText.split('\n').map(p => p.trim()).filter(p => p);
    
    if (phones.length === 0) {
        alert('Por favor, digite pelo menos um número de telefone.');
        return;
    }
    
    const payload = {
        phones: phones,
        message: message,
        priority: priority
    };
    
    if (scheduledFor) {
        payload.scheduled_for = scheduledFor;
    }
    
    fetch('/api/sms/send-bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('bulkSmsForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('bulkSmsModal')).hide();
            loadStats(); // Recarregar estatísticas
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao adicionar SMS à fila');
    });
}

// Carregar dados quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadActiveCommands();
    
    // Recarregar estatísticas a cada 30 segundos
    setInterval(loadStats, 30000);
});
</script>
{% endblock %}
